import type { RelativeMountPath, RunfilesDirPath, WorkspaceName } from '../link_node_modules';
import { getProposedSymlinks, inferRunfilesDirFromPath } from '../link_node_modules';

describe(inferRunfilesDirFromPath.name, () => {
  it('infer from linker script referenced via runfiles directory', () => {
    const runfilesDir = inferRunfilesDirFromPath(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/build_bazel_rules_nodejs/internal/linker/index.js',
    );
    expect(runfilesDir).toBe(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/',
    );
  });
  it('infer from RUNFILES environment variable', () => {
    const runfilesDir = inferRunfilesDirFromPath(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles',
    );
    expect(runfilesDir).toBe(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/',
    );
  });
  it('infer from cwd', () => {
    const runfilesDir = inferRunfilesDirFromPath(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fig/fib.sh.runfiles/com_canva_canva',
    );
    expect(runfilesDir).toBe(
      '/__output_base__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fig/fib.sh.runfiles/',
    );
  });
  it('no runfiles directory present', () => {
    expect(() => inferRunfilesDirFromPath('/')).toThrow();
  });
});

describe(getProposedSymlinks.name, () => {
  it('produces expected results', () => {
    const symlinks = getProposedSymlinks(
      {
        roots: {
          ['foo' as RelativeMountPath]: 'foo_node_modules' as WorkspaceName,
          ['foo/bar' as RelativeMountPath]: 'foobar_node_modules' as WorkspaceName,
          ['baz' as RelativeMountPath]: 'baz_node_modules' as WorkspaceName,
        },
        workspace: 'com_canva_canva' as WorkspaceName,
      },
      '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/' as RunfilesDirPath,
    );

    expect(symlinks).toEqual([
      [
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/com_canva_canva/foo/node_modules',
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/foo_node_modules/node_modules',
      ],
      [
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/com_canva_canva/foo/bar/node_modules',
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/foobar_node_modules/node_modules',
      ],
      [
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/com_canva_canva/baz/node_modules',
        '/__bazel__/execroot/com_canva_canva/bazel-out/darwin-dbg/bin/fib/fib.sh.runfiles/baz_node_modules/node_modules',
      ],
    ]);
  });
});
